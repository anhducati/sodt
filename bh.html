<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Qu·∫£n l√Ω Phi·∫øu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .copied { background-color: #d1e7dd !important; }
    .toast-container { position: fixed; top: 1rem; right:1rem; z-index:9999; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3 class="mb-4">D·ªØ li·ªáu Phi·∫øu</h3>
    <input type="file" id="excelFile" class="form-control mb-3" accept=".xlsx,.xls"/>
    <button class="btn btn-danger mb-3" onclick="confirmReset()">Reset d·ªØ li·ªáu</button>
    <div class="table-responsive">
      <table id="dataTable" class="table table-bordered table-sm"></table>
    </div>
    <div class="toast-container">
      <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex"><div class="toast-body">ƒê√£ sao ch√©p!</div></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJj1VfJGJCIFPuxvAv9rvJ1IPa_M4FSLc",
      authDomain: "chunganh-6a6a4.firebaseapp.com",
      projectId: "chunganh-6a6a4",
      storageBucket: "chunganh-6a6a4.appspot.com",
      messagingSenderId: "915399377703",
      appId: "1:915399377703:web:673aa6ff073f6f7a301f02",
      databaseURL: "https://chunganh-6a6a4-default-rtdb.firebaseio.com"
    };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getDatabase(app);

    const copyToast = new bootstrap.Toast(document.getElementById('copyToast'));

    const kmRanges = {
      1:[1500,3800],2:[6500,7500],3:[9500,11000],4:[13000,15000],
      5:[16500,17500],6:[19500,21500],7:[23500,24500],
      8:[26500,27300],9:[29000,31000]
    };
    const tienMap = {1:25000,2:45000,3:70000,4:45000,5:45000,6:70000,7:45000,8:45000,9:70000};

    let jsonRows = [];

    document.getElementById("excelFile").addEventListener("change", e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(sheet, {header:1}).slice(1);
        jsonRows = rows.map((row, idx) => {
          const phieu = parseInt(row[5]);
          const km = kmRanges[phieu]? (Math.floor(Math.random()*(kmRanges[phieu][1]-kmRanges[phieu][0]+1))+kmRanges[phieu][0]) : '';
          return {
            id: idx,
            date: row[0], tenXe: row[1], tenNguoi: row[2],
            soKhung: row[3], soPhieu: phieu,
            km, tien: tienMap[phieu]||0,
            dd: parseInt((row[0]||"").split("/")[0])||0
          };
        });
        jsonRows.sort((a,b)=>a.dd-b.dd);
        jsonRows.forEach((r,i)=>r.stt=i+1);
        renderTable();
        // l∆∞u tr·∫°ng th√°i ch∆∞a copy ƒë·∫øn firebase n·∫øu c·∫ßn
      };
      reader.readAsArrayBuffer(file);
    });

    async function renderTable(){
      const tbody = document.createElement("tbody");
      const table = document.getElementById("dataTable");
      table.innerHTML = `<thead><tr><th>STT</th><th>Ng√†y</th><th>S·ªë khung</th><th>Phi·∫øu</th><th>KM</th><th>S·ªë ti·ªÅn</th><th>Copy</th></tr></thead>`;
      for(const row of jsonRows){
        const tr = document.createElement("tr");
        tr.id = `row-${row.id}`;
        const cells = [row.stt,row.date,row.soKhung,row.soPhieu,row.km,row.tien];
        cells.forEach((v,i)=>{
          const td = document.createElement("td");
          td.textContent = v;
          tr.appendChild(td);
        });
        const tdBtn = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-outline-primary";
        btn.textContent = "üìã";
        btn.onclick = async ()=>{
          await navigator.clipboard.writeText(`${row.soKhung}\t${row.km}\t${row.tien}`);
          await update(ref(db, 'copied/' + row.id), {copied:true});
          tr.classList.add("copied");
          copyToast.show();
        };
        tdBtn.appendChild(btn);
        tr.appendChild(tdBtn);

        // load tr·∫°ng th√°i copy t·ª´ firebase
        const snap = await get(ref(db, 'copied/' + row.id));
        if(snap.exists() && snap.val().copied){
          tr.classList.add("copied");
        }

        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
    }

    async function confirmReset(){
      const pw = prompt("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ reset:");
      if(pw=== "0823163929"){
        await remove(ref(db, 'copied'));
        jsonRows=[]; document.getElementById("dataTable").innerHTML="";
      } else {
        alert("Sai m·∫≠t kh·∫©u!");
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Qu·∫£n l√Ω Phi·∫øu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .copied {
      background-color: #d1e7dd !important;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3 class="mb-4">D·ªØ li·ªáu phi·∫øu</h3>
    <input type="file" id="excelFile" class="form-control mb-3" accept=".xlsx,.xls">
    <button class="btn btn-danger mb-3" onclick="confirmReset()">Reset d·ªØ li·ªáu</button>
    <div class="table-responsive">
      <table id="dataTable" class="table table-bordered table-sm"></table>
    </div>
    <div class="toast-container">
      <div class="toast align-items-center text-bg-success border-0" id="copyToast" role="alert">
        <div class="d-flex">
          <div class="toast-body">ƒê√£ sao ch√©p!</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const copyToast = new bootstrap.Toast(document.getElementById('copyToast'));
    let copiedValues = JSON.parse(localStorage.getItem('copiedValues') || '[]');

    let globalData = JSON.parse(localStorage.getItem('savedData') || '[]');

    document.addEventListener("DOMContentLoaded", () => {
      if (globalData.length) renderTable();
    });

    document.getElementById('excelFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        let json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        let rows = json.slice(1);
        globalData = rows.map((row, idx) => {
          const dateParts = (row[0] || '').split('/');
          const dd = parseInt(dateParts[0]) || 0;

          const phieu = parseInt(row[5]);
          let tien = 0;
          if ([1].includes(phieu)) tien = 25000;
          else if ([2, 4, 5, 7, 8].includes(phieu)) tien = 45000;
          else if ([3, 6, 9].includes(phieu)) tien = 70000;

          return {
            date: row[0],
            tenXe: row[1],
            tenNguoi: row[2],
            soKhung: row[3],
            soPhieu: row[5],
            dd: dd,
            tien: tien
          };
        });

        globalData.sort((a, b) => a.dd - b.dd);
        localStorage.setItem('savedData', JSON.stringify(globalData));
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    });

    function renderTable() {
      const table = document.getElementById('dataTable');
      table.innerHTML = '';

      const headers = ['STT', 'Ng√†y', 'T√™n xe', 'T√™n ng∆∞·ªùi', 'S·ªë khung', 'S·ªë phi·∫øu', 'S·ªë ti·ªÅn'];
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.innerText = h;
        tr.appendChild(th);
      });
      table.appendChild(tr);

      globalData.forEach((row, idx) => {
        const tr = document.createElement('tr');
        const values = [
          idx + 1,
          row.date,
          row.tenXe,
          row.tenNguoi,
          row.soKhung,
          row.soPhieu,
          row.tien
        ];

        values.forEach((value, colIdx) => {
          const td = document.createElement('td');
          td.textContent = value;

          // Ch·ªâ th√™m n√∫t copy ·ªü c√°c c·ªôt c√≥ th·ªÉ c·∫ßn (T√™n ng∆∞·ªùi, S·ªë khung, S·ªë phi·∫øu)
          if ([4, 5, 6].includes(colIdx)) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-outline-primary';
            btn.textContent = 'üìã';
            btn.onclick = function () {
              navigator.clipboard.writeText(value);
              if (!copiedValues.includes(value)) {
                copiedValues.push(value);
                localStorage.setItem('copiedValues', JSON.stringify(copiedValues));
              }
              td.classList.add('copied');
              copyToast.show();
            }

            if (copiedValues.includes(value)) {
              td.classList.add('copied');
            }

            td.appendChild(document.createTextNode(' '));
            td.appendChild(btn);
          }

          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    function confirmReset() {
      const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ reset:");
      if (pass === "0823163929") {
        localStorage.removeItem('savedData');
        localStorage.removeItem('copiedValues');
        globalData = [];
        copiedValues = [];
        document.getElementById('dataTable').innerHTML = '';
        document.getElementById('excelFile').value = '';
        alert("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c reset!");
      } else {
        alert("Sai m·∫≠t kh·∫©u!");
      }
    }
  </script>
</body>
</html>
