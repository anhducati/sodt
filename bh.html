<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Import dữ liệu từ Excel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .copied {
      background-color: #d1e7dd !important;
    }
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 9999;
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-3">Import Excel</h2>
    <input type="file" id="fileInput" class="form-control mb-3" accept=".xlsx" />
    <button class="btn btn-danger mb-3" onclick="confirmReset()">Reset dữ liệu</button>
    <table id="dataTable" class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>STT</th>
          <th>Phiếu</th>
          <th>Số khung</th>
          <th>Ngày</th>
          <th>KM</th>
          <th>Số tiền</th>
          <th>Copy</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="toast-container">
    <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Đã sao chép!</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const kmRanges = {
      1: [1500, 3800],
      2: [6500, 7500],
      3: [9500, 11000],
      4: [13000, 15000],
      5: [16500, 17500],
      6: [19500, 21500],
      7: [23500, 24500],
      8: [26500, 27300],
      9: [29000, 31000],
    };

    const tienMapping = {
      1: 25000,
      2: 45000,
      3: 70000,
      4: 45000,
      5: 45000,
      6: 70000,
      7: 45000,
      8: 45000,
      9: 70000,
    };

    const copiedSet = new Set();

    document.getElementById("fileInput").addEventListener("change", handleFile);

    function handleFile(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        json.sort((a, b) => {
          const getDay = (v) => parseInt(String(v).split("/")[0]);
          return getDay(a.Ngày) - getDay(b.Ngày);
        });

        renderTable(json);
        saveData(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      data.forEach((row, index) => {
        const stt = index + 1;
        const phieu = parseInt(row["Phiếu"]);
        const km = getRandomKM(kmRanges[phieu] || [0, 0]);
        const tien = tienMapping[phieu] || 0;
        const rowId = `row-${stt}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${stt}</td>
          <td>${row["Phiếu"]}</td>
          <td id="khung-${stt}">${row["Số khung"]}</td>
          <td>${row["Ngày"]}</td>
          <td id="km-${stt}">${km}</td>
          <td id="tien-${stt}">${tien}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="copyRow(${stt})">Sao chép</button>
          </td>
        `;

        if (copiedSet.has(stt)) tr.classList.add("copied");
        tbody.appendChild(tr);
      });
    }

    function getRandomKM([min, max]) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function copyRow(index) {
      const khung = document.getElementById(`khung-${index}`).innerText;
      const km = document.getElementById(`km-${index}`).innerText;
      const tien = document.getElementById(`tien-${index}`).innerText;

      const text = `${khung}\t${km}\t${tien}`;
      navigator.clipboard.writeText(text);

      copiedSet.add(index);
      document.querySelector(`#row-${index}`)?.classList.add("copied");
      showToast();
    }

    function showToast() {
      const toast = new bootstrap.Toast(document.getElementById("copyToast"));
      toast.show();
    }

    function saveData(data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "data.json";
      a.click();
    }

    function confirmReset() {
      const pass = prompt("Nhập mật khẩu để reset:");
      if (pass === "0823163929") {
        location.reload();
      } else {
        alert("Sai mật khẩu!");
      }
    }
  </script>
</body>
</html>
